<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ´»åŠ¨ç­¾åˆ°</title>
    <style>
        body { margin: 0; padding: 20px; font-family: -apple-system, sans-serif; background: #f7f8fa; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; }
        .container { background: white; padding: 30px 20px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .title { font-size: 24px; font-weight: 800; color: #333; text-align: center; margin-bottom: 10px; }
        .subtitle { font-size: 14px; color: #999; text-align: center; margin-bottom: 30px; }
        
        .form-group { margin-bottom: 20px; }
        .label { font-size: 14px; color: #666; margin-bottom: 8px; display: block; font-weight: 600; }
        .input { width: 100%; padding: 15px; font-size: 16px; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; background: #f9f9f9; outline: none; transition: all 0.3s; }
        .input:focus { background: white; border-color: #07c160; }
        
        .btn { width: 100%; padding: 16px; font-size: 18px; font-weight: bold; color: white; background: linear-gradient(135deg, #07c160, #05a050); border: none; border-radius: 50px; margin-top: 20px; box-shadow: 0 8px 20px rgba(7,193,96,0.3); }
        .btn:active { transform: scale(0.98); }
        
        .success-box { display: none; text-align: center; padding: 40px 0; }
        .icon { width: 80px; height: 80px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container" id="formBox">
        <div class="title">ğŸ‘‹ æ¬¢è¿å‚åŠ æ´»åŠ¨</div>
        <div class="subtitle">è¯·å¡«å†™ä¿¡æ¯å®Œæˆç­¾åˆ°</div>
        
        <div class="form-group" id="nameGroup" style="display: none;">
            <label class="label">çœŸå®å§“å</label>
            <input type="text" id="name" class="input" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
        </div>
        
        <div class="form-group">
            <label class="label">æ‰‹æœºå·</label>
            <input type="tel" id="phone" class="input" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·" maxlength="11">
        </div>
        
        <button class="btn" id="submitBtn" onclick="submit()">ä¸‹ä¸€æ­¥</button>
    </div>

    <div class="container success-box" id="successBox">
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M512 0C229.23 0 0 229.23 0 512s229.23 512 512 512 512-229.23 512-512S794.77 0 512 0z m244.65 375.49L464.09 720.08a42.42 42.42 0 0 1-31.52 14.28 42.42 42.42 0 0 1-32.09-14.85l-175.76-197.74a42.67 42.67 0 0 1 63.61-56.54l145.74 163.96 261.07-310.16a42.67 42.67 0 1 1 65.51 56.46z" fill="#07C160"></path></svg>
        <div class="title">ç­¾åˆ°æˆåŠŸ</div>
        <div class="subtitle">æ‚¨å·²å®Œæˆç­¾åˆ°ï¼Œè¯·å…¥åœº</div>
    </div>

    <!-- ç¡®è®¤å¼¹çª— -->
    <div class="container" id="confirmBox" style="display:none; text-align: center;">
        <div class="title" style="margin-bottom:20px;">ğŸ¤” ç¡®è®¤èº«ä»½</div>
        <div class="subtitle" id="confirmMsg" style="text-align:left; line-height:1.6; color:#333;"></div>
        
        <div style="margin-top: 30px;">
            <button class="btn" id="btnYes" style="background: #07c160; margin-bottom: 15px;">æ˜¯çš„ï¼Œè¿™æ˜¯æˆ‘</button>
            <button class="btn" id="btnNo" style="background: #f5f5f5; color: #666; font-weight:normal;">ä¸æ˜¯ï¼Œæˆ‘æ˜¯æ–°äºº</button>
        </div>
    </div>

    <script>
        var currentCandidates = [];
        var isStepTwo = false; // æ˜¯å¦åœ¨ç­‰å¾…è¾“å…¥å§“åé˜¶æ®µ

        function submit(extraData) {
            var phone = document.getElementById('phone').value.trim();
            // å¦‚æœæ˜¯ç¬¬äºŒæ­¥ï¼Œè·å–å§“å
            var name = isStepTwo ? document.getElementById('name').value.trim() : '';

            // åŸºç¡€æ ¡éªŒ
            if (phone.length !== 11) {
                alert('è¯·å¡«å†™æ­£ç¡®çš„11ä½æ‰‹æœºå·');
                return;
            }
            if (isStepTwo && !name) {
                alert('è¯·å¡«å†™çœŸå®å§“å');
                return;
            }

            var payload = { phone: phone };
            // å¦‚æœå¤„äºç¬¬äºŒæ­¥ï¼Œå¿…é¡»å¸¦ä¸Š name
            if (isStepTwo) payload.name = name;
            
            // é¢å¤–çš„ confirming é€»è¾‘
            if (extraData) {
                for (var key in extraData) payload[key] = extraData[key];
            }

            var btn = document.getElementById('submitBtn');
            var originalText = btn.innerText;
            btn.innerText = 'å¤„ç†ä¸­...';
            btn.disabled = true;

            fetch('/api/checkin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                btn.innerText = originalText;
                btn.disabled = false;

                if (data.success) {
                    // ç­¾åˆ°æˆåŠŸ
                    document.getElementById('formBox').style.display = 'none';
                    document.getElementById('confirmBox').style.display = 'none';
                    document.getElementById('successBox').style.display = 'block';
                } 
                else if (data.needName) {
                    // æ–°é€»è¾‘ï¼šåç«¯æ²¡æ‰¾åˆ°äººï¼Œè¦æ±‚è¾“å…¥åå­—
                    document.getElementById('nameGroup').style.display = 'block';
                    document.getElementById('name').focus();
                    btn.innerText = 'ç¡®è®¤å½•å…¥å¹¶ç­¾åˆ°';
                    // æ ‡è®°çŠ¶æ€ä¸ºç¬¬äºŒæ­¥
                    isStepTwo = true;
                    // æç¤ºç”¨æˆ·
                    alert('æœªæ‰¾åˆ°æ‚¨çš„æŠ¥åä¿¡æ¯ï¼Œè¯·è¾“å…¥å§“åå®Œæˆç°åœºå½•å…¥ã€‚');
                }
                else if (data.requiresConfirmation) {
                    showConfirmation(data.candidates);
                } 
                else {
                    alert('æç¤º: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(function(err) { 
                btn.innerText = originalText;
                btn.disabled = false;
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•'); 
            });
        }

        function showConfirmation(candidates) {
            currentCandidates = candidates;
            var candidate = candidates[0];
            
            document.getElementById('formBox').style.display = 'none';
            document.getElementById('confirmBox').style.display = 'block';
            
            // ç®€å•çš„æ¨¡æ¿æ›¿æ¢
            var msg = 'æœªæ‰¾åˆ°æ‰‹æœºå· <b>' + document.getElementById('phone').value + '</b><br>' +
                      'ä½†æ•°æ®åº“ä¸­æœ‰æç›¸ä¼¼çš„è®°å½•ï¼š<br><br>' +
                      '<div style="background:#f9f9f9; padding:15px; border-radius:8px; text-align:left;">' +
                      '<div style="font-size:16px; font-weight:bold; margin-bottom:5px;">' + candidate.name + '</div>' +
                      '<div style="color:#666;">æ‰‹æœºï¼š<span style="color:#07c160; font-family:monospace; font-weight:bold;">' + candidate.maskedPhone + '</span></div>' +
                      '<div style="font-size:12px; color:#999; margin-top:5px;">(åŒ¹é…åŸå› : ' + (candidate.matchType || 'ç›¸ä¼¼') + ')</div>' +
                      '</div>' +
                      '<br>è¯·ç¡®è®¤è¿™æ˜¯æ‚¨å—ï¼Ÿ';
            
            document.getElementById('confirmMsg').innerHTML = msg;

            document.getElementById('btnYes').onclick = function() {
                submit({ useExistingPhone: candidate.phone });
            };
            
            document.getElementById('btnNo').onclick = function() {
                submit({ confirmNew: true });
            };
        }
    </script>
</body>
</html>
