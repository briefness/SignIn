<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨ç­¾åˆ°å¤§å±</title>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; display: flex; height: 100vh; }
        .sidebar { width: 350px; background: white; padding: 40px; display: flex; flex-direction: column; align-items: center; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        
        h1 { font-size: 24px; color: #333; margin-bottom: 30px; }
        .qr-box { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 40px; text-align: center; }
        .qr-img { width: 220px; height: 220px; display: block; }
        .qr-text { margin-top: 15px; color: #666; font-size: 14px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-item { background: white; border-radius: 16px; padding: 25px 15px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.02); transition: transform 0.2s; }
        .stat-item:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.05); }
        .stat-num { font-size: 48px; font-weight: 800; color: #333; line-height: 1.2; margin-bottom: 5px; }
        .stat-label { font-size: 15px; color: #888; font-weight: 500; }

        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .list-title { font-size: 28px; font-weight: bold; color: #333; }
        
        .user-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .user-card { background: white; padding: 20px; border-radius: 16px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03); transition: all 0.3s; }
        .user-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .avatar { width: 50px; height: 50px; background: #e8f8f0; color: #07c160; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; margin-right: 15px; }
        .info { flex: 1; }
        .name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .phone { font-size: 14px; color: #999; }
        .time { font-size: 12px; color: #ccc; margin-top: 4px; }
        .new-tag { background: #ffedea; color: #ff4d4f; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>ğŸš€ æ´»åŠ¨ç­¾åˆ°æ§åˆ¶å°</h1>
        <div class="qr-box">
            <img id="qrImg" class="qr-img" src="" alt="åŠ è½½ä¸­...">
            <div class="qr-text">è¯·æ‰«æäºŒç»´ç ç­¾åˆ°</div>
            <div class="qr-text" style="font-size: 12px; margin-top:5px; color:#999;" id="tunnelUrl"></div>
        </div>
        
        <div class="stats-box">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-num" id="stat-total">0</div>
                    <div class="stat-label">æŠ¥åæ€»äººæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num" id="stat-checked" style="color: #07c160;">0</div>
                    <div class="stat-label">å·²ç­¾åˆ°æ€»æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num" id="stat-original" style="color: #07c160;">0</div>
                    <div class="stat-label">åå•å†…ç­¾åˆ°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num" id="stat-new" style="color: #ff4d4f;">0</div>
                    <div class="stat-label">ç°åœºæ–°å¢</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="document.getElementById('fileInput').click()" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; background:white; cursor:pointer;">ğŸ“‚ å¯¼å…¥åå•</button>
                <button onclick="exportData()" style="flex:1; padding:10px; border-radius:8px; border:none; background:#07c160; color:white; cursor:pointer;">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
                <input type="file" id="fileInput" accept=".xlsx,.csv" style="display:none" onchange="uploadFile(this)">
            </div>
        </div>
    </div>

    <div class="main">
        <div class="list-header">
            <div class="list-title">å®æ—¶åŠ¨æ€</div>
        </div>
        <div class="user-list" id="userList">
            <!-- åˆ—è¡¨é¡¹ -->
        </div>
    </div>

    <script>
        // =========================================================
        // æ ¸å¿ƒæ”¹åŠ¨ï¼šå‰ç«¯ LocalStorage æ¥ç®¡æ‰€æœ‰æ•°æ®
        // åç«¯ server.js ä»…ç”¨äºï¼š
        // 1. è§£æ Excel (å› ä¸ºæµè§ˆå™¨è§£æ Excel æ¯”è¾ƒéº»çƒ¦ï¼Œå·æ‡’ç”¨åç«¯)
        // 2. ç”ŸæˆäºŒç»´ç  (åŒç†)
        // 3. ä½œä¸ºç®€å•çš„ API Proxy
        // =========================================================

        const DB_KEY = 'vibe_signin_db_v1';
        
        // è·å–æœ¬åœ°æ•°æ®
        function getLocalData() {
            const raw = localStorage.getItem(DB_KEY);
            return raw ? JSON.parse(raw) : [];
        }

        // ä¿å­˜æœ¬åœ°æ•°æ®
        function saveLocalData(list) {
            localStorage.setItem(DB_KEY, JSON.stringify(list));
            updateUI(); // ä¿å­˜å³åˆ·æ–°
        }

        // è½®è¯¢è·å–äºŒç»´ç  (å‰ç«¯ç”Ÿæˆé“¾æ¥ï¼Œä¸å†å®Œå…¨ä¾èµ–åç«¯è¿”å›çš„ url)
        // åç«¯å¯èƒ½æ‹¿ä¸åˆ°å‡†ç¡®çš„å¤–ç½‘åŸŸåï¼Œå‰ç«¯è‡ªå·±æ‹¼æ¥æœ€ç¨³å¦¥
        function loadQRCode() {
            // æ„é€ ç­¾åˆ°é¡µåœ°å€ï¼šå½“å‰åŸŸåçš„ /form.html
            const signInUrl = window.location.origin + '/form.html';
            const tunnelUrlElement = document.getElementById('tunnelUrl');
            
            // æ˜¾ç¤ºæ–‡æœ¬è¿æ¥
            tunnelUrlElement.innerText = signInUrl;
            tunnelUrlElement.style.color = '#666';

            // è¯·æ±‚åç«¯å¸®æˆ‘ä»¬ç”ŸæˆäºŒç»´ç å›¾ç‰‡ (æˆ–è€…å¼•å…¥å‰ç«¯ QR åº“ï¼Œä¸ºäº†çœäº‹è¿˜æ˜¯è®©åç«¯ç”Ÿæˆå›¾ç‰‡)
            // æˆ‘ä»¬æŠŠè¿™ä¸ªæ­£ç¡®çš„ URL ä¼ ç»™åç«¯ï¼Œè®©å®ƒç”Ÿæˆå›¾ç‰‡è¿”å›
            // ä½†å…¶å®åç«¯ /api/tunnel æ¥å£ä¸æ¥å—å‚æ•°...
            
            // æ–¹æ¡ˆï¼šä¿®æ”¹ loadQRCode é€»è¾‘ï¼Œç›´æ¥è®©åç«¯è¿”å›å›¾ç‰‡å³å¯ï¼Ÿ
            // ä¸ï¼ŒVercel åç«¯ç”Ÿæˆçš„ URL å¯èƒ½æ˜¯é”™çš„ (http/https ä¸å¯¹ï¼Œæˆ–è€… host ä¸å¯¹)
            // æœ€ç®€å•çš„æ–¹å¼ï¼šä¸ç”¨åç«¯ç”ŸæˆäºŒç»´ç äº†ï¼Œç›´æ¥ç”¨ä¸€ä¸ªå…¬å…± API ç”Ÿæˆï¼Œæˆ–è€…è®©åç«¯åªè´Ÿè´£ç”»å›¾
            
            // ä¿®æ­£ï¼šæˆ‘ä»¬ç›´æ¥å‘Šè¯‰ç”¨æˆ·é“¾æ¥ï¼Œå›¾ç‰‡å¦‚æœåŠ è½½ä¸å‡ºæ¥å°±ç®—äº†...
            // ä¸è¡Œï¼Œä½“éªŒä¸å¥½ã€‚
            
            // é‡æ–°å°è¯•ç”¨åç«¯ç”Ÿæˆï¼Œä½†å¦‚æœåç«¯ç”Ÿæˆçš„ URL å’Œå½“å‰ URL ä¸ä¸€è‡´ï¼Œå°±ä»¥å‰ç«¯ä¸ºå‡†
            fetch('/api/tunnel')
                .then(res => res.json())
                .then(data => {
                    const img = document.getElementById('qrImg');
                    // å¦‚æœæ˜¯ Vercel ç¯å¢ƒï¼Œåç«¯çš„ URL å¯èƒ½æ˜¯ http çš„ï¼Œä½†æˆ‘ä»¬ç°åœ¨æ˜¯ https
                    // å¼ºåˆ¶ä½¿ç”¨å‰ç«¯è·å–çš„ origin
                    if (data.qr) {
                        // å¦‚æœåç«¯ç”Ÿæˆçš„äºŒç»´ç å†…å®¹ä¸å¯¹ï¼ˆæ¯”å¦‚ protocol åªæœ‰ httpï¼‰ï¼Œ
                        // è¿™é‡Œå…¶å®æ²¡æ³•æ”¹å›¾ç‰‡å†…å®¹...
                        // ä½†é€šå¸¸ Vercel çš„ x-forwarded-proto æ˜¯å‡†çš„ã€‚
                        // å¦‚æœâ€œæ‰“ä¸å¼€â€ï¼Œå¤§æ¦‚ç‡æ˜¯äºŒç»´ç é‡Œçš„é“¾æ¥æ˜¯ http://... è€Œä¸æ˜¯ https://...
                        // æˆ–è€…åŸŸåé‡Œæœ‰ä»€ä¹ˆæ€ªå­—ç¬¦ã€‚
                        
                        img.src = data.qr;
                        img.style.display = 'block';
                    }
                })
                .catch(e => console.error(e));
        }

        // æ¸²æŸ“ç•Œé¢ (å®Œå…¨è¯»å–æœ¬åœ°æ•°æ®ï¼Œä¸è¯·æ±‚åç«¯ /api/list)
        function updateUI() {
            const list = getLocalData();
            
            // 1. è®¡ç®—ç»Ÿè®¡
            const checkedInList = list.filter(i => i.status === 'checked_in');
            const newCheckedIn = checkedInList.filter(i => i.isNew || i.source === 'scan_new').length;
            const originalCheckedIn = checkedInList.length - newCheckedIn;
            const originalTotal = list.filter(i => !i.isNew).length;

            document.getElementById('stat-total').innerText = originalTotal;
            document.getElementById('stat-checked').innerText = checkedInList.length;
            document.getElementById('stat-original').innerText = originalCheckedIn;
            document.getElementById('stat-new').innerText = newCheckedIn;

            // 2. æ¸²æŸ“åˆ—è¡¨ (å€’åº)
            const sorted = [...list].sort((a, b) => (b.checkInTime || 0) - (a.checkInTime || 0));
            const container = document.getElementById('userList');
            
            // ä»…æ˜¾ç¤ºå·²ç­¾åˆ°çš„
            const displayList = sorted.filter(i => i.status === 'checked_in');
            
            container.innerHTML = displayList.map(user => {
                const time = user.checkInTime ? new Date(user.checkInTime).toLocaleTimeString() : '';
                const showNew = user.isNew || user.source === 'scan_new';
                const newTag = showNew ? '<span class="new-tag">æ–°</span>' : '';
                return `
                    <div class="user-card">
                        <div class="avatar">${user.name[0]}</div>
                        <div class="info">
                            <div class="name">${user.name}${newTag}</div>
                            <div class="phone">${user.phone}</div>
                            <div class="time">${time} ç­¾åˆ°</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ–‡ä»¶å¯¼å…¥ (ä¸Šä¼ ç»™åç«¯è§£æ -> æ‹¿åˆ°æ•°æ®å­˜æœ¬åœ°)
        function uploadFile(input) {
            if (input.files && input.files[0]) {
                const formData = new FormData();
                formData.append('file', input.files[0]);
                
                fetch('/api/import', { method: 'POST', body: formData })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.data) {
                            // æ‹¿åˆ°è§£æåçš„æ•°æ®ï¼Œè¦†ç›–æœ¬åœ°
                            // ä¹Ÿå¯ä»¥åšåˆå¹¶é€»è¾‘ï¼Œè¿™é‡Œç®€åŒ–ä¸ºè¦†ç›–
                            saveLocalData(data.data);
                            alert(`å¯¼å…¥æˆåŠŸï¼å…± ${data.count} æ¡æ•°æ® (å·²å­˜å…¥æµè§ˆå™¨ç¼“å­˜)`);
                        } else {
                            alert('å¯¼å…¥å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                    })
                    .catch(e => alert('ç½‘ç»œé”™è¯¯'));
                
                input.value = ''; 
            }
        }
        
        // å¯¼å‡ºæ•°æ® (å‰ç«¯ç›´æ¥ç”Ÿæˆ Excelï¼Œä¸éº»çƒ¦åç«¯äº†)
        // æ—¢ç„¶æ•°æ®éƒ½åœ¨å‰ç«¯ï¼Œç”¨ SheetJS å‰ç«¯åº“ç”Ÿæˆæ›´æ–¹ä¾¿ï¼Ÿ
        // ç®—äº†ï¼Œä¸ºäº†ä¸å¼•å…¥æ–°åº“ï¼Œè¿˜æ˜¯æŠŠæ•°æ®å‘ç»™åç«¯ç”Ÿæˆå§ï¼Œæˆ–è€…ç®€å•çš„ CSV
        function exportData() {
            // ç®€å•ç‰ˆï¼šå‰ç«¯ç”Ÿæˆ CSV
            const list = getLocalData();
            let csvContent = "\uFEFFå§“å,æ‰‹æœºå·,çŠ¶æ€,ç­¾åˆ°æ—¶é—´,æ˜¯å¦æ–°äºº\n";
            list.forEach(row => {
                const time = row.checkInTime ? new Date(row.checkInTime).toLocaleString() : '';
                const status = row.status === 'checked_in' ? 'å·²ç­¾åˆ°' : 'æœªç­¾åˆ°';
                const isNew = row.isNew ? 'æ˜¯' : 'å¦';
                csvContent += `${row.name},${row.phone},${status},${time},${isNew}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "ç­¾åˆ°æ•°æ®.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ¨¡æ‹Ÿï¼šç›‘å¬æ¥è‡ªæ‰«ç é¡µé¢çš„â€œç­¾åˆ°æˆåŠŸâ€æ¶ˆæ¯
        // å› ä¸ºæ‰«ç é¡µé¢ (form.html) å’Œè¿™ä¸ªæ§åˆ¶å°é¡µé¢ (index.html) æ˜¯åˆ†å¼€çš„
        // å®ƒä»¬é€šå¸¸ä¸å…±äº« Storage (å¦‚æœæ˜¯åŒæºå¯ä»¥ï¼ŒVercel ä¸Šæ˜¯ä¸€æ ·çš„)
        // ä¸ºäº†å®æ—¶åŒæ­¥ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„è½®è¯¢åç«¯ï¼Ÿ
        // ä¸è¡Œï¼Œåç«¯ä¸å¯é ã€‚
        
        // === å…³é”®ç­–ç•¥ï¼šæ··åˆæ¨¡å¼ ===
        // æ§åˆ¶å°é¡µé¢ (index.html) æ˜¯â€œä¸»â€ï¼Œæ•°æ®åœ¨å®ƒè¿™é‡Œã€‚
        // æ‰«ç é¡µé¢ (form.html) æäº¤æ•°æ®ç»™åç«¯ -> åç«¯è®°å½•åˆ°å†…å­˜ -> æ§åˆ¶å°è½®è¯¢åç«¯è·å–â€œå¢é‡â€ã€‚
        
        // ä¿®æ­£é€»è¾‘ï¼š
        // 1. åŸºç¡€åå•åœ¨ index.html æœ¬åœ°ã€‚
        // 2. æ‰«ç ç­¾åˆ°æ—¶ï¼Œåç«¯å†…å­˜è‚¯å®šä¼šæœ‰ä¸€ä»½ä¸´æ—¶è®°å½•ã€‚
        // 3. index.html è½®è¯¢åç«¯ /api/listï¼ŒæŠŠåç«¯é‡ŒçŠ¶æ€ä¸º checked_in çš„äººï¼Œ
        //    åŒæ­¥æ›´æ–°åˆ°æœ¬åœ° LocalStorage é‡Œã€‚
        
        setInterval(() => {
            fetch('/api/list')
                .then(res => res.json())
                .then(remoteList => {
                    const localList = getLocalData();
                    let hasChange = false;

                    // éå†è¿œç¨‹æ•°æ®ï¼ŒåŒæ­¥åˆ°æœ¬åœ°
                    remoteList.forEach(remoteUser => {
                        if (remoteUser.status === 'checked_in') {
                            // æ‰¾æœ¬åœ°åŒ¹é…çš„
                            let localUser = localList.find(u => u.phone === remoteUser.phone);
                            
                            if (localUser) {
                                // åªæœ‰å½“æœ¬åœ°è¿˜æ²¡ç­¾åˆ°æ—¶æ‰æ›´æ–°
                                if (localUser.status !== 'checked_in') {
                                    localUser.status = 'checked_in';
                                    localUser.checkInTime = remoteUser.checkInTime || Date.now();
                                    hasChange = true;
                                }
                            } else {
                                // æœ¬åœ°æ²¡æœ‰ -> è¯´æ˜æ˜¯ç°åœºæ–°äºº
                                localList.push(remoteUser);
                                hasChange = true;
                            }
                        }
                    });

                    if (hasChange) {
                        saveLocalData(localList); // æ›´æ–°æœ¬åœ°å¹¶åˆ·æ–° UI
                        console.log('åŒæ­¥äº†æ–°çš„ç­¾åˆ°æ•°æ®');
                    }
                })
                .catch(e => console.log('Sync error (expected if server sleeping)'));
                
            // æ— è®ºæ˜¯åŒæ­¥äº†è¿˜æ˜¯æ²¡åŒæ­¥ï¼Œéƒ½è¦åˆ·æ–° UI ä»¥æ˜¾ç¤ºæ—¶é—´å˜åŒ–
            // å…¶å® updateUI å¼€é”€å¾ˆå°
            // updateUI(); 
        }, 3000);

        // å¯åŠ¨
        loadQRCode();        // é¦–æ¬¡åŠ è½½
        updateUI();          // é¦–æ¬¡æ¸²æŸ“æœ¬åœ°æ•°æ®
        
        // æˆ‘ä»¬ä¸å†éœ€è¦ updateData() è½®è¯¢åç«¯ statsï¼Œå› ä¸ºé‚£ä¼šå¯¼è‡´é—ªçƒ
        // æˆ‘ä»¬åªéœ€è¦ä¸Šé¢çš„ setInterval åŒæ­¥å¢é‡ç­¾åˆ°å³å¯
        // setInterval(updateData, 3000);  <-- è¿™ä¸ªå¿…é¡»åˆ æ‰ï¼
    </script>
</body>
</html>
